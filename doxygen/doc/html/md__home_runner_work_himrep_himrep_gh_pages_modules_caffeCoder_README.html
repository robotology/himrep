<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>himrep: Table of Contents</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">himrep
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Table of Contents </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#description">Description</a></li>
<li><a href="#installation">Installation</a><ul>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#compilation">Compilation</a></li>
</ul>
</li>
<li><a href="#setup">Setup</a><ul>
<li><a href="#download-binary-caffe-models-caffemodel">Download binary Caffe models (.caffemodel)</a></li>
<li><a href="#configure-prototxt-and-ini-with-absolute-paths">Configure .prototxt and .ini with absolute paths</a></li>
</ul>
</li>
<li><a href="#detailed-explanation">Detailed explanation</a></li>
<li><a href="#additional-notes-on-caffe-installation">Additional notes on Caffe installation</a></li>
<li><a href="#citation">Citation</a></li>
<li><a href="#license">License</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md0"></a>
Description</h1>
<p>This module is a basic YARP wrapper for <a href="http://caffe.berkeleyvision.org/">Caffe</a>, which receives as input a stream of images (of type <code>yarp::sig::Image</code>), feeds them to a Convolutional Neural Network (CNN) model and produces as output a corresponding stream of vectors (of type <code>yarp::sig::Vector</code>), which can be extracted from any CNN layer.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Installation</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
Dependencies</h2>
<p>The libraries that are needed to compile this module are:</p>
<ul>
<li><a href="https://github.com/robotology/yarp">YARP</a></li>
<li><a href="https://github.com/robotology/icub-main">iCub</a></li>
<li><a href="http://opencv.org/releases.html">OpenCV</a></li>
<li><a href="https://www.github.com/BVLC/caffe.git">Caffe</a></li>
<li><a href="https://developer.nvidia.com/cuda-zone">CUDA</a>: this is an optional dependency of Caffe and also of this module. However, we strongly recommend to rely on a powerful enough NVIDIA CUDA-enabled GPU (with Compute Capability &gt;= 3.0) in order to achieve a good frame rate.</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Compilation</h2>
<p>Provided that the dependencies are satified, you can compile this module just by setting the <code>BUILD_caffeCoder</code> flag to <code>ON</code> as explained <a href="https://www.github.com/robotology/himrep#compilation">here</a>.</p>
<p>When you run the <code>ccmake</code> command, ensure also that:</p>
<ul>
<li>the <code>Caffe_DIR</code> flag is correctly pointing to a valid Caffe installation</li>
<li>the flag <code>CUDA_USE_STATIC_CUDA_RUNTIME</code> is set to <code>OFF</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Setup</h1>
<p>This module can use arbitrary Caffe models: the only contraint is that the model must have an input data layer of kind <a href="http://caffe.berkeleyvision.org/tutorial/layers/memorydata.html">MemoryData</a>. However, this can be easily achieved for most models just by replacing the input data layer in the model definition file. In the following, we report istructions on how to setup the module to use either one of two well-known models, <code>ResNet-50</code> and <code>CaffeNet</code>.</p>
<p>The setup procedure basically follows the <a href="http://caffe.berkeleyvision.org/gathered/examples/feature_extraction.html">Extracting Features</a> example provided with Caffe. If you are not interested in the details, you can execute the following instructions and use one of these two models with the default module parameters. We provide a little more explanataion hereafter for those who want to try different or custom Caffe models and settings.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Download binary Caffe models (.caffemodel)</h2>
<p>If you don't have setted it already, for convenience, set the <code>Caffe_ROOT</code> env variable pointing to your <code>caffe</code> source code directory.</p>
<p>For <code>CaffeNet</code> we can follow the instructions on <a href="http://caffe.berkeleyvision.org/model_zoo.html">caffe</a> website:</p>
<div class="fragment"><div class="line">$ cd $Caffe_ROOT</div>
<div class="line">$ scripts/download_model_binary.py models/bvlc_reference_caffenet</div>
<div class="line"># for this model we need also to get the mean image of the training set of ILSVRC</div>
<div class="line">$ ./data/ilsvrc12/get_ilsvrc_aux.sh</div>
</div><!-- fragment --><p>For <code>ResNet-50</code> we can get the weights as indicated <a href="https://github.com/KaimingHe/deep-residual-networks">here</a>:</p>
<div class="fragment"><div class="line">$ cd $Caffe_ROOT/models</div>
<div class="line">$ mkdir ResNet50</div>
<div class="line">$ cd ResNet50</div>
</div><!-- fragment --><p>by downloading, in this folder, the <code>ResNet-50-model.caffemodel</code> file from the <a href="https://onedrive.live.com/?authkey=%21AAFW2-FVoxeVRck&amp;id=4006CBB8476FF777%2117887&amp;cid=4006CBB8476FF777">OneDrive link</a> specified at the webpage.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Configure .prototxt and .ini with absolute paths</h2>
<p>We have now to customize two files in order to use the downloaded Caffe model. These are provided for some Caffe models (the two considered here plus <code>GoogLeNet</code>) with the source code of the module (inside <code>app/conf</code>) and are:</p>
<ul>
<li>a <code>.ini</code> file for the <code>caffeCoder</code> module, specifying some parameters and pointing to the Caffe model's binary and definition files</li>
<li>the <code>.prototxt</code> Caffe model's definition file, where we have replaced the input data layer with one of kind <code>MemoryData</code></li>
</ul>
<h3><a class="anchor" id="autotoc_md7"></a>
File .prototxt: configuration</h3>
<p>Import the <code>.prototxt</code> files from <code>himrep</code> for the <code>CaffeNet</code> and <code>ResNet-50</code> architectures in order to customize them for your system:</p>
<div class="fragment"><div class="line">$ yarp-config context --import himrep bvlc_reference_caffenet_val.prototxt</div>
<div class="line">$ yarp-config context --import himrep resnet_val.prototxt</div>
</div><!-- fragment --><p>For <code>CaffeNet</code> we need to do:</p>
<div class="fragment"><div class="line">$ cd ~/.local/share/yarp/contexts/himrep</div>
<div class="line">$ gedit bvlc_reference_caffenet_val.prototxt</div>
</div><!-- fragment --><p>At line 10, replace the following:</p>
<div class="fragment"><div class="line">mean_file: &quot;/path/to/train_mean.binaryproto&quot;</div>
</div><!-- fragment --><p>with the correct absolute path to this file on your system (without using env variables). This is the binary file containing the mean image of the training set of ILSVRC we just downloaded. In this case this is:</p>
<div class="fragment"><div class="line">mean_file: &quot;$Caffe_ROOT/data/ilsvrc12/imagenet_mean.binaryproto&quot;</div>
</div><!-- fragment --><p>where you must replace the <code>$Caffe_ROOT</code> env variable with its full value.</p>
<p>For <code>ResNet-50</code> we do not need to modify anything.</p>
<h3><a class="anchor" id="autotoc_md8"></a>
File .ini: configuration</h3>
<p>Import the <code>.ini</code> files from <code>himrep</code> for the <code>CaffeNet</code> and <code>ResNet-50</code> in order to customize them on your system:</p>
<div class="fragment"><div class="line"># CaffeNet</div>
<div class="line">$ yarp-config context --import himrep caffeCoder_caffenet.ini</div>
<div class="line">$ yarp-config context --import himrep caffeCoder_resnet.ini</div>
</div><!-- fragment --><p>For each of them we must set the following variables to the correct paths: <code>caffemodel_file</code> and <code>prototxt_file</code>.</p>
<p>For <code>CaffeNet</code> do:</p>
<div class="fragment"><div class="line">$ cd ~/.local/share/yarp/contexts/himrep</div>
<div class="line">$ gedit caffeCoder_caffenet.ini</div>
</div><!-- fragment --><p>And then set:</p>
<div class="fragment"><div class="line">caffemodel_file $Caffe_ROOT/models/bvlc_reference_caffenet/bvlc_reference_caffenet.caffemodel</div>
<div class="line">prototxt_file ~/.local/share/yarp/contexts/himrep/bvlc_reference_caffenet_val.prototxt</div>
</div><!-- fragment --><p>replacing the <code>$Caffe_ROOT</code> env variable and <code>~/</code> with their full values.</p>
<p>For <code>ResNet-50</code> do:</p>
<div class="fragment"><div class="line">gedit caffeCoder_resnet.ini</div>
</div><!-- fragment --><p>And then set:</p>
<div class="fragment"><div class="line">caffemodel_file $Caffe_ROOT/models/ResNet50/ResNet-50-model.caffemodel</div>
<div class="line">prototxt_file ~/.local/share/yarp/contexts/himrep/resnet_val.prototxt</div>
</div><!-- fragment --><p>replacing the <code>$Caffe_ROOT</code> env variable and <code>~/</code> with their full values.</p>
<p>For other parameters and input and output ports we refer to the module documentation <a href="http://robotology.github.io/himrep/doxygen/doc/html/group__caffeCoder.html">here</a>.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Detailed explanation</h1>
<p>In Caffe, the weights of network models are stored in a <code>.caffemodel</code> file, whose absolute path must be provided to the <code>caffeCoder</code> in the <code>caffemodel_file</code> parameter. The network definition file to be used in inference mode instead is usually called <code>deploy.prototxt</code> and must be provided to the <code>caffeCoder</code> in the <code>prototxt_file</code> parameter.</p>
<p>In Caffe's <a href="http://caffe.berkeleyvision.org/model_zoo.html">Model Zoo</a> there are many models available with related descriptions and usage instructions. You can use them with <code>caffeCoder</code>, by copying their <code>deploy.prototxt</code> and replacing their input layer with a corresponding <code>MemoryData</code> layer.</p>
<p>In order to correctly use a network in inference mode, the mean image (or pixel) of the training set that has been used to learn the model parameters must be subtracted from any image that is fed to the model. The mean image is usully stored in Caffe with a <code>.binaryproto</code> file. You will to specify this in the <code>MemoryData</code> layer and:</p>
<ul>
<li>if the mean image is subtracted, the <code>.binaryproto</code> file must be downloaded and correctly pointed by the <code>.prototxt</code> in your system (<code>mean_file</code> field of the <code>MemoryData</code> layer);</li>
<li>if the mean pixel is subtracted, you will need to specify, in the <code>.ini</code> file, two additional parameters (as, e.g., we do in <code>caffeCoder_googlenet.ini</code>) related to the width and height (<code>resizeWidth</code> and <code>resizeHeight</code>) to which the input image will be resized before being fed to the <code>MemoryData</code> layer.</li>
</ul>
<p>Another important parameter to be set in the <code>.ini</code> file is the tag/name of the output of the layer we want to read. This can be specified by setting the <code>blob_name</code> parameter.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Additional notes on Caffe installation</h1>
<p>For a complete and continuously updated guide to how to install Caffe in any configuration you should go to <a href="http://caffe.berkeleyvision.org/installation.html">Caffe - Installation</a>. We do not cover here exhaustively the procedure. We just report the procedure we followed at present (07/2017) to use Caffe from this module on Ubuntu 16.04 LTS.</p>
<h4><a class="anchor" id="autotoc_md11"></a>
CUDA installation</h4>
<p>Download and install CUDA drivers and toolkit by following <a href="http://docs.nvidia.com/cuda/cuda-installation-guide-linux/#axzz4BkDT7m6r">CUDA Installation Guide for Linux</a>.</p>
<h4><a class="anchor" id="autotoc_md12"></a>
cuDNN installation (optional but recommended)</h4>
<p>Download the <b>cuDNN</b> version you need (depending on the toolkit version) from <a href="https://developer.nvidia.com/cuDNN">NVIDIA cuDNN library</a> (you have to sign up as CUDA Registered Developer, it's for free), and install it by following the instructions.</p>
<h4><a class="anchor" id="autotoc_md13"></a>
BLAS installation</h4>
<p>We chose the <b>OpenBLAS</b> implementation but also ATLAS or Intel MKL are supported by Caffe. You can either download the source code from <a href="http://www.openblas.net/">OpenBLAS page</a> and follow instructions to compile and install it, or install the package. In the latter case, you can just do:</p>
<div class="fragment"><div class="line">sudo apt-get install libopenblas-dev</div>
</div><!-- fragment --><p>In case you compile the source code, we recommend to install in a separate and specified location of your choice instead of the default <code>/usr/local</code> by doing:</p>
<div class="fragment"><div class="line">tar -xzvf &lt;downloaded-openblas-archive-name&gt;.tar.gz</div>
<div class="line">cd &lt;downloaded-openblas-archive-name&gt;</div>
<div class="line">make PREFIX=/path/to/install/dir install</div>
</div><!-- fragment --><p> and setting the <code>OpenBLAS_HOME</code> environment variable to the installation path to allow Caffe finding it.</p>
<h4><a class="anchor" id="autotoc_md14"></a>
BOOST installation</h4>
<p>As for BLAS, you can either download the source code from <a href="http://www.boost.org/">Boost C++ Libraries</a> and follow instructions to compile and install it, or install the package. In any case, check the supported versions on Caffe website. For convenience, again we report the followed instructions (that can be found on Boost page) to compile from source:</p>
<div class="fragment"><div class="line">tar --bzip2 -xf &lt;downloaded-boost-archive&gt;.tar.bz2</div>
<div class="line">cd &lt;downloaded-boost-archive&gt;</div>
<div class="line">./bootstrap.sh --prefix=path/to/install/dir</div>
<div class="line">./b2 install</div>
</div><!-- fragment --><p> and set the <code>Boost_DIR</code> environment variable to the installation path to allow Caffe finding it, or to download the package:</p>
<div class="fragment"><div class="line">sudo apt-get install libboost-all-dev</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md15"></a>
OpenCV installation</h4>
<p>OpenCV comes with the <code>icub-common</code> package. In case you need to compile it from source, you can download the source code from <a href="http://opencv.org/downloads.html">OpenCV - Downloads</a> and compile it through the usual:</p>
<div class="fragment"><div class="line">unzip &lt;downloaded-opencv-archive-name&gt;.zip</div>
<div class="line">cd &lt;downloaded-opencv-archive-name&gt;</div>
<div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">ccmake ../</div>
<div class="line">make</div>
<div class="line">make install</div>
</div><!-- fragment --><p>Where in the CMake configuration you should have set the installation path (<code>CMAKE\_INSTALL\_PREFIX</code>) to one of your choice. In this case, set the <code>OpenCV_DIR</code> environment variable to the installation path to allow Caffe finding it.</p>
<h4><a class="anchor" id="autotoc_md16"></a>
Other packages</h4>
<p>Refer to <a href="http://caffe.berkeleyvision.org/install_apt.html">Caffe - Ubuntu Installation</a> for updated instructions or manual installation. On Ubunutu 16.04 LTS at the time being we have done:</p>
<p>Google Protobuf Buffers C++:<br  />
 <code>sudo apt-get install libprotobuf-dev protobuf-compiler</code></p>
<p>Google Logging:<br  />
 <code>sudo apt-get install libgoogle-glog-dev</code></p>
<p>Google Flags:<br  />
 <code>sudo apt-get install libgflags-dev</code></p>
<p>LevelDB:<br  />
 <code>sudo apt-get install libleveldb-dev</code></p>
<p>HDF5:<br  />
 <code>sudo apt-get install libhdf5-serial-dev</code></p>
<p>LMDB:<br  />
 <code>sudo apt-get install liblmdb-dev</code></p>
<p>snappy:<br  />
 <code>sudo apt-get install libsnappy-dev</code></p>
<h4><a class="anchor" id="autotoc_md17"></a>
Caffe compilation</h4>
<p>Since Caffe is under active development, we try to be compatible with the changes progressively introduced in the framework and periodically check the compatibility of <code>caffeCoder</code> against its <code>master</code> branch. Therefore you can refer to it and clone it:</p>
<div class="fragment"><div class="line">git clone https://www.github.com/BVLC/caffe.git</div>
</div><!-- fragment --><p>Note that at present <a href="https://github.com/BVLC/caffe/releases">Caffe RC3</a> is not compatible anymore with <code>caffeCoder</code>.</p>
<p>In order to be able to link Caffe from an external project via CMake (as this application does) you should compile Caffe via CMake and not manually editing the Makefile.config.</p>
<p>Related instructions can be found at <a href="http://caffe.berkeleyvision.org/installation.html">Caffe - Installation</a> or <a href="https://github.com/BVLC/caffe/pull/1667">here</a>. Generally you can do:</p>
<div class="fragment"><div class="line">cd caffe</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">ccmake ../ (NOTE *)</div>
<div class="line">make all</div>
<div class="line">make runtest</div>
<div class="line">make install</div>
</div><!-- fragment --><p><b>NOTE</b> In the configuration step:</p>
<ul>
<li>you should be able to link to all installed dependencies, if you have set correctly the environment variables</li>
<li>set BLAS to <code>open</code> or <code>Open</code> if you installed OpenBLAS as we did: if you still see that the Atlas implementation is not found, this might be an issue with Caffe: in any case, if you check by toggling the advanced mode, you should see that OpenBLAS has been found in your installation directory</li>
<li>there is no need to build the Matlab wrapper for Caffe</li>
<li>use the cuDNN library if possible (set USE_CUDNN to ON)</li>
<li><p class="startli"><b>important if you are on Ubuntu 16.04 and use GCC 5.3 with CUDA 7.5</b>: as noted <a href="https://github.com/BVLC/caffe/issues/4046">here</a>, in this case you need to modify the <code>CMAKE_CXX_FLAGS</code> CMake variable by appending to it the <code>-D_FORCE_INLINES</code> flag. You can do it during the interactive configuration step with <code>ccmake</code> or by modifying the following line in the <code>CMakeLists.txt</code>:</p>
<p class="startli">``` set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC -D_FORCE_INLINES -Wall") ```</p>
</li>
</ul>
<p>Finally, set the <code>Caffe_DIR</code> environment variable to the installation path to allow finding Caffe via <code>find_package</code>.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Citation</h1>
<p>This module has been presented and benchmarked in the iCub scenario in the following paper:</p>
<p><a href="http://jmlr.csail.mit.edu/proceedings/papers/v43/pasquale15.pdf">Teaching iCub to recognize objects using deep Convolutional Neural Networks</a> <em>Giulia Pasquale, Carlo Ciliberto, Francesca Odone, Lorenzo Rosasco and Lorenzo Natale</em>, Proceedings of The 4th Workshop on Machine Learning for Interactive Systems, pp. 21–25, 2015 </p><pre class="fragment">@inproceedings{pasquale15,
author  = {Giulia Pasquale and Carlo Ciliberto and Francesca Odone and Lorenzo Rosasco and Lorenzo Natale},
title   = {Teaching iCub to recognize objects using deep Convolutional Neural Networks},
journal = {Proceedings of the 4th Workshop on Machine Learning for Interactive Systems, 32nd International Conference on Machine Learning},
year    = {2015},
volume  = {43},
pages   = {21--25},
url     = {http://www.jmlr.org/proceedings/papers/v43/pasquale15}
}
</pre> <h1><a class="anchor" id="autotoc_md19"></a>
License</h1>
<p>Material included here is Copyright of <em>iCub Facility - Istituto Italiano di Tecnologia</em> and is released under the terms of the GPL v2.0 or later. See the file LICENSE for details. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
